#### Автор - [Тарба Александр](https://vk.com/korotkoeimya1112)
#### Задание - [Методические указания](https://github.com/init/highload/blob/main/homework_architecture.md)

#### Содержание:
1. [Тема, функционал и аудитория](#1)
2. [Расчёт нагрузки](#2)


## Часть 1. Тема, функционал и аудитория <a name="1"></a>

### Тема курсовой работы - **"Проектирование высоконагруженнного сервиса голосового помощника"**
В качестве примера выбран [Google Ассистент](assistant.google.com)

### Ключевой функционал сервиса
- Создание напоминаний и уведомлений
- Поисковые запросы
- Прослушивание музыки

### Ключевые продуктовые решения
- Поддержка нескольких языков
- Хранение пользовательских событий на сервере
- Синхронизация пользователя на нескольких устройствах 
- Голосовой ввод запросов и озвучивание ответа 

### Целевая аудитория
- более 500 миллионов активных пользователей по всему миру [^1]

## Часть 2. Расчёт нагрузки <a name="2"></a>

### Продуктовые метрики
По статистике, приведенной в [^2], около 46% активных пользователей используют голосовой помощник ежедневно, таким образом можно оценить среднее число пользователей в день.

Пользователи выполняют $3.1$ миллиарда поисковых запросов в месяц [^2], из которых примерно 36% приходится на Google Assistant [^2], т.е. в месяц выполняется около $$3.1~млрд * 0.36 / 30 = 37.2~млн~запросов/день.$$

Исследование, провденное в статье [^8] утверждает, что в случае с Google примерно 23.4% запросов приходятся на музыку. 

Зная процент, приходящийся на поисковые запросы и запросы воспроизведения музыки, можно составить пропорцию на число запросов воспроизведения музыки: $$37.2~млн * 0.234 / 0.36 = 24.8~млн~запросов/день.$$


<!-- Траффик по стриму звука можно рассчитать умножив объем кодированного звука в секунду на длительности стрима: $$25.2 * 320 = $$ -->

|Метрика|Значение|
|-------|--------|
|MAU|$500~млн~пользователей$[^1]|
|DAU|$230~млн~пользователей$[^2]|
|Число поисковых запросов в день|$37.2~млн$|
|Число запросов в день на музыку|$24.8~млн$|
|Средний размер хранилища для истории| $2.5~Гб$|


### Технические метрики
#### Обоснование расчета технических метрик
Средняя длина английских слов составляет $5.43$ символа [^6].
Средняя длина ответа в Google Ассистенте согласно [^3] составляет 43 слова, а средняя длина вопроса составляет 29 слов [^4]. Таким образом суммарная длина запроса в символах составляет $(43+29)*5.43=391~символ$.

Таким образом для хранения ответа и вопроса необходимо $(43+29)*5.43=391~байт$. 

__Умножая на число запросов в день, получаем необходимый размер памяти для хранения текстов вопросов и ответов, т.е.:__ $$391 * 37.2~млн = 14 546~Гб.$$

Согласно [^5] средняя скорость английской речи составлявет $170~слов/минуту$ (английская речь относится к языкам с достаточно быстрым темпом речи, поэтому можно считать, что такая оценка является верхней границей реальных данных с учетом того, что большая часть запросов поступает на английском языке).

__Таким образом, можно оценить время озвучивания вопроса и ответа следующей формулой:__ $$(43+29)/170=0.42~минут = 25.2~секунд$$

Объем звука рассчитывается по формуле: $$I = f*r*k*t,$$ где $f$ - частота дискретизации, $r$ - глубина кодирования, $k$ - количество каналов, $t$ - время кодирования [^7]. 

Согласно [^8] объем секунды звука в приемлемом качестве составляет $320~Кбайт/с$.

__Тогда средний объем траффика по запросу и ответу можно вычислить, умножив продожлительность записи звука на объем секунды звука, получим:__ $$25.2 * 320 = 8064~Кбайт.$$

Запрос воспроизведения музыки должен содержать команду для ассистента с указанием воспроизвести музыку, опционального указания группы и название песни или плейлиста.

Открытые данные по средней длине запроса на воспроизведение музки не обнародуются, поэтому с учетом того, что запрос на воспроизведения музыки должен содержать меньше слов, чем поисковой запрос, в связи с особенностями построения предложения на воспроизведения музыки, можно воспользоваться средней оценкой длины поискового запроса и считать ее мажорантной для случая с запросом на воспроизведение музыки.

Сервис голосового ассистента не замнимается транслированием музыки, поэтому запрос перенаправляется в другой сервис, специализирующийся на этом.

#### Расчет технических метрик
#### Расчет RPS
RPS по поисковым запросам рассчитывается следующим образом: $$37.2 * 10^6 / 24 / 60 / 60 = 430~запрос/c$$

RPS по запросам на музыку рассчитывается следующим образом: $$24.8 * 10^6 / 24 / 60 / 60 = 287~запрос/c$$

Положим, что пиковый RPS по поисковым запросам составляет $3/2$ от среднего, тогда пиковый RPS поисковых запросов: $$430 * 3 / 2 = 645~запроc/c.$$

Положим, что пиковый RPS по запросам на музыку составляет $3/2$ от среднего, тогда пиковый RPS поисковых запросов: $$287 * 3 / 2 = 431~запрос/c.$$

#### Расчет памяти
Объем памяти, необходимой для хранения истории запросов/ответов в год: $$14 546 Гб * 365 = 5185~Тб.$$

#### Расчет траффика
Положим, что пиковый траффик по поисковым запросам составляет $3/2$ от исходного, тогда пиковый траффик: $$(3/2 * 430) * 8064 * 1024 * 8 / 10^9 = 43~Гбит/c.$$

Положим, что пиковый траффик по запросам на музыку составляет $3/2$ от исходного, тогда пиковый траффик: $$(3/2 * 287) * 8064 * 1024 * 8 / 10^9 = 29~Гбит/c.$$

Суммарный суточный траффик по поисковым запросам, можно вычислить следующим образом: $$(37.2 * 10^6) * 8064 * 1024 / 1024 / 1024 / 1024 = 286~084~Гбайт/сутки.$$

Суммарный суточный траффик по запросам на музыку, можно вычислить следующим образом: $$(24.8 * 10^6) * 8064 * 1024 / 1024 / 1024 / 1024 = 190~723~Гбайт/сутки.$$

| Метрика                             | Значение        |
| ----------------------------------- | --------------- | 
| RPS по поисковым запросам           | $430~запрос/c$  |
| RPS по запросам на музыку           | $287~запрос/c$  |
| Пиковый RPS по поисковым  запросам  | $645~запрос/c$  |
| Пиковый RPS по запросам на музыку   | $431~запрос/c$  |
| Память                              |    $5185~Тб$    |
| Пиковый траффик по поисковым запросам|  $43~Гбит/c$   |
| Пиковый траффик по запросам на музыку|  $29~Гбит/c$   |
| Суточный траффик по поисковым запросам|$286~084~Гбайт/сутки$|
| Суточный траффик по запросам на музыку|$190~723~Гбайт/сутки$|


### Расчет глобальной нагрузки
Согласно [^10] основными пользователями голосовых ассистентов являются Америка, Европа и Китай, однако в Китае практически не используется Google Assistant в виду развитости собственных голосовых ассистентов. 
Также согласно [^11] примерно 37% американских жителей используют голосовой ассистент, что учитывая население Америки составляет 80% от общего числа пользователей головых ассистентов.
Таким образом дата центры должны располагаться в первую очередь в самых населенных городах на территории Америки и далее Европы, а также небольшая часть в удаленных местах, для ликвидации потенциальной возможности нагрузки сети медленными клиентами.

Американские дата центры:
- Нью-Йорк
- Сан-Франциско
- Сиэтл
- Даллас

Россия входит в топ 5 стран по числу запросов к Google Assistant [^10], поэтому для покрытия европейской части России, Сибири,Восточной части России и Японии целесообразно расположить их следующим образом
Российские дата центры:
- Москва
- Екатеринбург
- Владивосток

Есть статистика, утверждающая, что хинди, является вторым языком после английского по числу запросов к голосовому ассистенту (комментарий: потерял ссылку, и это вероятно связано с большим населением индии, так что не уверен, насколько целесообразно):
- Нью Дели

Удаленный дата центр для покрытия России и средней Азии:
- Алматы

Европа так же занимает большой процент рынка голосовых ассистентов:
- Лондон
- Париж 
- Стокгольм
- Берлин
- Стамбул (покрывает Азию, Северную Африку и Восточную Европу)

На юге Африки рассположим дата центр в наиболее экономически развитой стране (Юар):
- Претория

В Австралии:
- Сидней

### Список источников
[^1]: [Статистика Google Assistant](https://tech.hindustantimes.com/tech/news/ces-2020-google-assistant-hits-500-million-users-new-set-of-features-announced-story-oKAGV1xsMrrAYPPigMEGxK-4.html)
[^2]: [Статистика голосовых помощников](https://serpwatch.io/blog/voice-search-statistics/)
[^3]: [Статистика по длине ответа на запросы](https://searchengines.guru/ru/articles/2048581)
[^4]: [Статистика по длине запроса](https://pr-cy.ru/news/p/6995-golosovoy-poisk-sovety-po-optimizatsii-kontenta-i-issledovanie)
[^5]: [Средняя скорость английской речи](https://multiurok.ru/blog/skorost-riechi.html)
[^6]: [Средняя длина английских слов](https://qna.habr.com/q/554389)
[^7]: [Рассчет объема звука](https://zftsh.online/articles/4857)
[^8]: [Стандартные значения объема звука от времени](http://abcibc.com/computer-notebook-gadget.php?art=4)
[^9]: [Исследовательская статья про использование голосовых помощников](https://www.researchgate.net/publication/332745214_Music_Search_and_IoT_How_People_Really_Use_Voice_Assistants/link/5ced7feea6fdcc18c8e9654d/download?_tp=eyJjb250ZXh0Ijp7ImZpcnN0UGFnZSI6InB1YmxpY2F0aW9uIiwicGFnZSI6InB1YmxpY2F0aW9uIn19)
[^10]: [Рынок голосовых ассистентов по странам](https://medium.com/@foxymatveeva/journey-to-the-global-voice-market-the-us-europe-china-and-russia-8b47a4c3f8e)
[^11]: [Статистика использования голосовых ассистентов](https://www.demandsage.com/voice-search-statistics/)