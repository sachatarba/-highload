#### Автор - [Тарба Александр](https://vk.com/korotkoeimya1112)
#### Задание - [Методические указания](https://github.com/init/highload/blob/main/homework_architecture.md)

#### Содержание:
1. [Тема, функционал и аудитория](#1)
2. [Расчёт нагрузки](#2)
3. [Расчет глобальной нагрузки](#3)
4. [Расчет локальной нагрузки](#4)
5. [Логическая схема БД](#5)
6. [Физическая схема БД](#6)
7. [Алгоритм](#7)
8. [Технологии](#8)
9. [Обеспечение отказоустойчивости](#9)
10. [Схема проекта](#10)

## Часть 1. Тема, функционал и аудитория <a name="1"></a>

### Тема курсовой работы - **"Проектирование высоконагруженнного сервиса голосового помощника"**
В качестве примера выбран [Google Ассистент](assistant.google.com)

### Ключевой функционал сервиса
- Создание напоминаний и уведомлений
- Поисковые запросы
- Прослушивание музыки

### Ключевые продуктовые решения
- Поддержка нескольких языков
- Хранение пользовательских событий на сервере
- Синхронизация пользователя на нескольких устройствах 
- Голосовой ввод запросов и озвучивание ответа 

### Целевая аудитория
- более 500 миллионов активных пользователей по всему миру [^1]

## Часть 2. Расчёт нагрузки <a name="2"></a>

### Продуктовые метрики
По статистике, приведенной в [^2], около 46% активных пользователей используют голосовой помощник ежедневно, таким образом можно оценить среднее число пользователей в день.


Пользователи выполняют $3.1$ миллиарда поисковых запросов в месяц [^2], из которых примерно 36% приходится на Google Assistant [^2], т.е. в месяц выполняется около $$3.11 млрд * 0.36 / 30 = 37.2млн~запросов/день.$$

Исследование, провденное в статье [^8] утверждает, что в случае с Google примерно 23.4% запросов приходятся на музыку. 

Зная процент, приходящийся на поисковые запросы и запросы воспроизведения музыки, можно составить пропорцию на число запросов воспроизведения музыки: $$37.2 млн * 0.234 / 0.36 = 24.8млн запросов/день.$$


<!-- Траффик по стриму звука можно рассчитать умножив объем кодированного звука в секунду на длительности стрима: $$25.2 * 320 = $$ -->

|Метрика|Значение|
|-------|--------|
|MAU|$500~млн пользователей$[^1]|
|DAU|$230~млн пользователей$[^2]|
|Число поисковых запросов в день|$37.2~млн$|
|Число запросов в день на музыку|$24.8~млн$|
|Средний размер хранилища для истории| $5185~Тб$|


### Технические метрики
#### Обоснование расчета технических метрик
Средняя длина английских слов составляет $5.43$ символа [^6].
Средняя длина ответа в Google Ассистенте согласно [^3] составляет 43 слова, а средняя длина вопроса составляет 29 слов [^4]. Таким образом суммарная длина запроса в символах составляет $(43+29)*5.43=391~символ$.

Таким образом для хранения ответа и вопроса необходимо $(43+29)*5.43=391~байт$. 

__Умножая на число запросов в день, получаем необходимый размер памяти для хранения текстов вопросов и ответов, т.е.:__ $$391 * 37.2млн = 14 546~Гб.$$

Согласно [^5] средняя скорость английской речи составлявет $170слов/минуту$ (английская речь относится к языкам с достаточно быстрым темпом речи, поэтому можно считать, что такая оценка является верхней границей реальных данных с учетом того, что большая часть запросов поступает на английском языке).

__Таким образом, можно оценить время озвучивания вопроса и ответа следующей формулой:__ $$(43+29)/170=0.42минут = 25.2~секунд$$

Объем звука рассчитывается по формуле: $$I = frkt,$$ где $f$ - частота дискретизации, $r$ - глубина кодирования, $k$ - количество каналов, $t$ - время кодирования [^7]. 

Согласно [^8] объем секунды звука в приемлемом качестве составляет $320~Кбайт/с$.

__Тогда средний объем траффика по запросу и ответу можно вычислить, умножив продожлительность записи звука на объем секунды звука, получим:__ $$25.2 * 320 = 8064~Кбайт.$$

Запрос воспроизведения музыки должен содержать команду для ассистента с указанием воспроизвести музыку, опционального указания группы и название песни или плейлиста.

Открытые данные по средней длине запроса на воспроизведение музки не обнародуются, поэтому с учетом того, что запрос на воспроизведения музыки должен содержать меньше слов, чем поисковой запрос, в связи с особенностями построения предложения на воспроизведения музыки, можно воспользоваться средней оценкой длины поискового запроса и считать ее мажорантной для случая с запросом на воспроизведение музыки.

Сервис голосового ассистента не замнимается транслированием музыки, поэтому запрос перенаправляется в другой сервис, специализирующийся на этом.

#### Расчет технических метрик
#### Расчет RPS
RPS по поисковым запросам рассчитывается следующим образом: $$37.2 * 10^6 / 24 / 60 / 60 = 430~запрос/c$$

RPS по запросам на музыку рассчитывается следующим образом: $$24.8 * 10^6 / 24 / 60 / 60 = 287~запрос/c$$

Положим, что пиковый RPS по поисковым запросам составляет $3/2$ от среднего, тогда пиковый RPS поисковых запросов: $$430 * 3 / 2 = 645~запроc/c.$$

Положим, что пиковый RPS по запросам на музыку составляет $3/2$ от среднего, тогда пиковый RPS поисковых запросов: $$287 * 3 / 2 = 431~запрос/c.$$

#### Расчет памяти
Объем памяти, необходимой для хранения истории запросов/ответов в год: $$14 546 Гб * 365 = 5185~Тб.$$

#### Расчет траффика
Положим, что пиковый траффик по поисковым запросам составляет $3/2$ от исходного, тогда пиковый траффик: $$(3/2 * 430) * 8064 * 1024 * 8 / 10^9 = 43~Гбит/c.$$

Положим, что пиковый траффик по запросам на музыку составляет $3/2$ от исходного, тогда пиковый траффик: $$(3/2 * 287) * 8064 * 1024 * 8 / 10^9 = 29~Гбит/c.$$

Суммарный суточный траффик по поисковым запросам, можно вычислить следующим образом: $$(37.2 * 10^6) * 8064 * 1024 / 1024 / 1024 / 1024 = 286084~Гбайт/сутки.$$

Суммарный суточный траффик по запросам на музыку, можно вычислить следующим образом: $$(24.8 * 10^6) * 8064 * 1024 / 1024 / 1024 / 1024 = 190723~Гбайт/сутки.$$

| Метрика                             | Значение        |
| ----------------------------------- | --------------- | 
| RPS по поисковым запросам           | $430~запрос/c$  |
| RPS по запросам на музыку           | $287~запрос/c$  |
| Пиковый RPS по поисковым  запросам  | $645~запрос/c$  |
| Пиковый RPS по запросам на музыку   | $431~запрос/c$  |
| Память                              |    $5185~Тб$    |
| Пиковый траффик по поисковым запросам|  $43~Гбит/c$   |
| Пиковый траффик по запросам на музыку|  $29~Гбит/c$   |
| Суточный траффик по поисковым запросам|$286084~Гбайт/сутки$|
| Суточный траффик по запросам на музыку|$190723~Гбайт/сутки$|


### Часть 3. Расчет глобальной нагрузки
#### Расположение дата центров
Согласно [^10] основными пользователями голосовых ассистентов являются Америка, Европа и Китай, однако в Китае практически не используется Google Assistant в виду развитости собственных голосовых ассистентов. 
Также согласно [^11] примерно 37% американских жителей используют голосовой ассистент, что учитывая население Америки составляет 80% от общего числа пользователей головых ассистентов.
Таким образом дата центры должны располагаться в первую очередь в самых населенных городах на территории Америки и далее Европы, а также небольшая часть в удаленных местах, для ликвидации потенциальной возможности нагрузки сети медленными клиентами.

Американские дата центры:
- Нью-Йорк
- Сан-Франциско
- Сиэтл
- Даллас

Россия входит в топ 5 стран по числу запросов к Google Assistant [^10], поэтому для покрытия европейской части России, Сибири, Восточной части России и Японии целесообразно расположить их следующим образом:
- Москва
- Екатеринбург
- Владивосток

Есть статистика, утверждающая, что хинди, является вторым языком после английского по числу запросов к голосовому ассистенту (комментарий: потерял ссылку, и это вероятно связано с большим населением индии, так что не уверен, насколько целесообразно):
- Нью Дели

Удаленный дата центр для покрытия России и средней Азии:
- Алматы

Европа так же занимает большой процент рынка голосовых ассистентов:
- Лондон
- Париж 
- Стокгольм
- Берлин
- Стамбул (покрывает Азию, Северную Африку и Восточную Европу)

На юге Африки рассположим дата центр в наиболее экономически развитой стране (ЮАР):
- Претория

В Австралии:
- Сидней

#### Карта дата центров
![map](/src/dc_map1.png)
![map](/src/dc_map2.png)

#### Выбор алгоритма балансировки
Дата центры расположены так, что нет необходимости отправлять запрос с одного континента на другой, т.е. на каждом континенте имеется достаточное число дата центров для обслуживания запросов. 

В данном случае целесообразно использовать алгоритм **наименьшего времени отклика**, что позволит направлять запросы к серверам, которые менее нагружены в данный момент и могут быстрее ответить на запрос [^12]. 

Если сервера на континенте не перегружены, запрос будет отправляться внутри континента к серверу с наименьшем временем отклика, но если запросов будет слишком много, то запрос может быть отправлен в более свободный дата центр на другом, что позволит оптимизировать время отклика и избежать ситуации перегрузки дата центров, в случае резкого повышения нагрузки.

### Часть 4. Расчет локальной нагрузки
Внутри дата центра будут использоваться два слоя балансировки L4 и L7, что рекомендуется в [^13] для обеспечения отказоустойчивости.

L7-балансировка на основе NGNIX для голосового ассистента будет использована для:
- Сжатия данных
- SSL терминация
- Обработка медленных клиентов (разгрузка сервера приложения), может не понадобиться при правильном использовании современных тенхологий, асинхронности и т.д.
- Вынесение авторизации на уровень NGNIX (при потенциальной необходимости появления в сервисе), при помощи написания расширений

Для обеспечения отказоустойчивости будет использована технология CARP, при падении одного из NGNIX, траффик будет перенаправлен на резервный.

L4-балансировка будет использована для распределения траффика между NGNIX, что повышает отказоустойчивость и решает проблему долгого нединамического перечитывания конфига NGNIX-ом.

#### Схема локальной балансировки
![локальная схема балансировки](/src/local.svg)

### Часть 5. Логическая схема БД
Логическая схема БД представлена ниже:
![логическая схема бд](/src/logic_db.svg)

Описание таблиц:
| Таблица                             | Описание       |
| ----------------------------------- | --------------- | 
| Users          | данные о пользователях  |
| Queries          | данные о запросах пользователей  |
| Sessions  | данные о сессиях пользователей  |

Память для таблицы Users может быть расчитана следующим образом:
- ID - 16 байт
- Login - 32 байт (верхняя оценка) 
- Password 10 байт [^14]

Умножая число пользователей на размер таблицы, получим:
$$500*10^6*(16+32+10)=27~Гбайт$$

Обращение к данной таблице происходит при авторизации, если предположить, что пользователь атворизуется раз в месяц, то RPS равен: $$500*10^6/(30*24*60*60)=192~запросов/секунду$$

Память для таблицы Queries может быть расчитана следующим образом:
- ID - 16 байт
- UserID - 16 байт
- QuerieText - 29 байт (средняя длина вопроса)  
- QreationDate - 4 байта 

Умножая число запросов в месяц на размер таблицы, получим:

$37.2*10^6*30*(16+16+29+4)=16.37~Мбайт$ - прирост размера таблицы за месяц

Обращение к данной таблице происходит при отправке поиксового запроса или запроса на музыку, т.е. RPS равен:
$$430+287=717~запросов/секунду$$

Память для таблицы Sessions может быть расчитана следующим образом:
- UserID - 16 байт
- Token - 16 байт 

Умножая число пользователей на размер таблицы, получим:
$$500*10^6*(16+16)=15~Гбайт$$

Обращение к данной таблице происходит при отправке поиского запроса или запроса на музыку, т.е RPS равен: $$430+287=717~запросов/секунду$$

| Таблица                             | Размер       |RPS|
| ----------------------------------- | --------------- |-| 
| Users          | $27~ГБайт$  |192|
| Queries          | $16.37~Мбайт$ (прирост в месяц)  |717|
| Sessions  | $15~ГБайт$  |717|

### Часть 6. Физическая схема БД.
![физическая схема бд](/src/phys_db.svg)
Для таблиц Users и Queries будет использована PostgreSQL, а для таблицы Sessions будет использован Redis.

#### Репликация
Каждая таблица будет иметь реплику, взаимодействие которой будет организовано по модели Master-Slave

#### Шардинг
Шардинг будет проводить по ID в таблице Users и UserID в таблице Queries, так чтобы данные об одном пользователи были физически на одном сервере

#### Патриционирование 
Можно выполнить партиционирование по дате создания в таблице Queries, что позволит добиться равномерного распределения данных внутри партиций

#### Индексы
PK индекс на ID в таблице Users, Unique индекс на Login, PK и FK индексы на ID и UserID таблицы Queries 

#### Клиентские библиотеки
Работа с PostrgreSQL: 
- gorm.io/gorm
- gorm.io/driver/postgres

Работа с Redis:
- go-redis

#### Балансировака запросов / мультиплексирование подключений
Для обеспечения мультипликсирование соединений будем использовать pgBouncer

#### Схема резеврного копирования 
Будем использовать совместно full backup и incremental backup для создания полных копий и копий данных, изменившихся с момента создания последнего backup [^15]. Full backup будем производить раз в неделю, incremental backup раз в сутки.

### Часть 7. Алгоритм
Весь алгоритм заключается в использовании модели, распознающей речь, но можно применить несколько подходов для оптимизации работы алгоритма.

1. Распараллеливание обработки аудиофайлов позволит ускорить процесс распознавания речи. Можно использовать многопоточность или распределенные системы обработки данных.

2. Использование оптимизированных библиотек и инструментов: Использование специализированных библиотек для обработки аудио, таких как TensorFlow или PyTorch, сможет ускорить выполнение алгоритма.

3. Использование графических процессоров (GPU) или специализированных процессоров для выполнения операций нейронных сетей для ускорения работы алгоритма.

4. Мониторинг использования ресурсов, таких как CPU и память, поможет оптимизировать работу алгоритма и предотвратить перегрузку системы.

### Часть 8. Технологии
| Тенхология                             |Применение|
| ----------------------------------- | --------------- | 
| PostgreSQL  |Хранение данных, реплицирование, шардирование, бэкап|
| Go | Многопоточные неблокирующие сервера бекенда  |
| Redis | быстрое key-value хранилище для сессий  |
|Python| язык для распознавания речи|
|Kubernetes| Технология для автоматизации развертывания контейнеров, перезапуска, проверки работы, распределения по физ. серверам|
|Ngnix|L7 балансировщик нагрузки|
|PgBouncer|Мультиплексирование соединений к PostgreSQL|

### Часть 9. Обеспечение отказоустойчивости
#### База данных
Обеспечение отказоустойчивости базы данных реализуется при помощи реплицирования по модели Master-Slave и создания бекапов.
#### Балансировщик нагрузки NGNIX
Будет установлено несколько балансировщиков нагрузки NGNIX, каждый из которых будет находится в CARP-группе, т.е. если один из балансировщиков из пары выходит из строя, он подменяется резервным.
#### L4 Балансировка
Запросы на NGNIX будут балансироваться при помощи L4 балансировки, что позволяет обеспечить отказоустойчивость равной уровню отказоусточивости железа.
#### Несколько workerов
Будет несколько экземлпяров воркеров, что обеспечивает равномерно перераспределение нагрузки между воркерами, в случае отказа одного из них
#### Healthcheck нод Kubernetes
Автоматический перезапуск нод Kubernetes, когда они перестают отвечать [^16].

#### Принципы
- retry-запросы - отправка повторых запросов по timeout, обеспечивается при помощи NGNIX, позволяет решить проблему в случае, если один из воркеров перестал работать
- Graceful shutdown - обеспечение сохранения запросов в случае приостановки системы, можно поддерживать благодаря Kubernetes
- Graceful degradation - обеспечение архитектуры, устойчивой к выходу из строя одного или несколько компонентов. Необходимо уменьшать количество "узких мест" - обеспечивается моделями Master-Slave, CARP и т.д.

### Часть 10. Схема проекта
![схема проекта](/src/схема%20проекта.svg)
При помощи DNS определяется IP адрес дата центра к которому необходимо определить запрос, далее на слое L4 определяется NGNIX на который будет проксироваться запрос, надежность NGNIX определяется технологией CARP и присутствием нескольких NGNIX-серверов, далее NGNIX проксиует запрос на Application Server, при этом по таймауту запрос может быть переотправлен на другой application server, присутствие нескольких application server-ов обеспечивает равномерное распределение нагрузки и повышает отказоустойчивость. Application Server обращается к Redis и PostrgreSQL, надеждность которых обеспечивается моделью Master-Slave. Также для PostrgreSQL выполнено шардирование, что распределяет нагрузку на БД.
### Список источников
[^1]: [Статистика Google Assistant](https://tech.hindustantimes.com/tech/news/ces-2020-google-assistant-hits-500-million-users-new-set-of-features-announced-story-oKAGV1xsMrrAYPPigMEGxK-4.html)
[^2]: [Статистика голосовых помощников](https://serpwatch.io/blog/voice-search-statistics/)
[^3]: [Статистика по длине ответа на запросы](https://searchengines.guru/ru/articles/2048581)
[^4]: [Статистика по длине запроса](https://pr-cy.ru/news/p/6995-golosovoy-poisk-sovety-po-optimizatsii-kontenta-i-issledovanie)
[^5]: [Средняя скорость английской речи](https://multiurok.ru/blog/skorost-riechi.html)
[^6]: [Средняя длина английских слов](https://qna.habr.com/q/554389)
[^7]: [Рассчет объема звука](https://zftsh.online/articles/4857)
[^8]: [Стандартные значения объема звука от времени](http://abcibc.com/computer-notebook-gadget.php?art=4)
[^9]: [Исследовательская статья про использование голосовых помощников](https://www.researchgate.net/publication/332745214_Music_Search_and_IoT_How_People_Really_Use_Voice_Assistants/link/5ced7feea6fdcc18c8e9654d/download?_tp=eyJjb250ZXh0Ijp7ImZpcnN0UGFnZSI6InB1YmxpY2F0aW9uIiwicGFnZSI6InB1YmxpY2F0aW9uIn19)
[^10]: [Рынок голосовых ассистентов по странам](https://medium.com/@foxymatveeva/journey-to-the-global-voice-market-the-us-europe-china-and-russia-8b47a4c3f8e)
[^11]: [Статистика использования голосовых ассистентов](https://www.demandsage.com/voice-search-statistics/)
[^12]: [Алгоритмы балансировки](https://aws.amazon.com/ru/what-is/load-balancing/)
[^13]: [L4 и L7 балансировка](https://habr.com/ru/companies/vk/articles/347026/)
[^14]: [Средний размер пароля](https://www.opennet.ru/opennews/art.shtml?num=53260)
[^15]: [Резервное копирование](https://www.ispsystem.ru/news/backup-101)
[^16]: [Работа с Kubernetes](https://habr.com/ru/articles/258443/)